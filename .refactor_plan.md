# Plan de RefactorizaciÃ³n: Arquitectura MVC

## Objetivo
Reorganizar el proyecto Flutter en una arquitectura MVC clara y mantenible.

## Estructura Propuesta

```
lib/
â”œâ”€â”€ models/              âœ… YA EXISTE
â”‚   â”œâ”€â”€ documento.dart
â”‚   â”œâ”€â”€ carpeta.dart
â”‚   â”œâ”€â”€ usuario.dart
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ views/               ğŸ†• NUEVA - Solo UI (Widgets visuales)
â”‚   â”œâ”€â”€ documentos/
â”‚   â”‚   â”œâ”€â”€ documentos_list_view.dart
â”‚   â”‚   â”œâ”€â”€ documento_detail_view.dart
â”‚   â”‚   â”œâ”€â”€ documento_form_view.dart
â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚       â”œâ”€â”€ documento_card.dart
â”‚   â”‚       â””â”€â”€ documento_filters.dart
â”‚   â”œâ”€â”€ carpetas/
â”‚   â”‚   â”œâ”€â”€ carpetas_view.dart
â”‚   â”‚   â””â”€â”€ carpeta_form_view.dart
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ usuarios_view.dart
â”‚   â”‚   â””â”€â”€ permisos_view.dart
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ login_view.dart
â”‚       â””â”€â”€ register_view.dart
â”‚
â”œâ”€â”€ controllers/         ğŸ†• NUEVA - LÃ³gica de negocio
â”‚   â”œâ”€â”€ documentos/
â”‚   â”‚   â”œâ”€â”€ documentos_controller.dart
â”‚   â”‚   â”œâ”€â”€ documento_detail_controller.dart
â”‚   â”‚   â””â”€â”€ documento_form_controller.dart
â”‚   â”œâ”€â”€ carpetas/
â”‚   â”‚   â””â”€â”€ carpetas_controller.dart
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”œâ”€â”€ usuarios_controller.dart
â”‚   â”‚   â””â”€â”€ permisos_controller.dart
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ auth_controller.dart
â”‚
â”œâ”€â”€ services/            âœ… YA EXISTE - ComunicaciÃ³n con API
â”‚   â”œâ”€â”€ documento_service.dart
â”‚   â”œâ”€â”€ carpeta_service.dart
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ providers/           âœ… YA EXISTE - Estado global
â”‚   â””â”€â”€ auth_provider.dart
â”‚
â”œâ”€â”€ widgets/             âœ… YA EXISTE - Componentes reutilizables
â”‚   â”œâ”€â”€ animated_card.dart
â”‚   â”œâ”€â”€ glass_container.dart
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ theme/               âœ… YA EXISTE
â”œâ”€â”€ utils/               âœ… YA EXISTE
â””â”€â”€ main.dart
```

## Responsabilidades

### ğŸ“‹ MODELO (models/)
- Clases de datos (POJOs/DTOs)
- SerializaciÃ³n JSON
- Validaciones de datos bÃ¡sicas
- **NO contiene lÃ³gica de negocio**

### ğŸ‘ï¸ VISTA (views/)
- **SOLO** widgets de UI
- Recibe datos del controlador
- Llama mÃ©todos del controlador en eventos
- **NO contiene lÃ³gica de negocio**
- **NO llama servicios directamente**

### ğŸ® CONTROLADOR (controllers/)
- LÃ³gica de negocio
- Manejo de estado local
- Llamadas a servicios
- Validaciones complejas
- NavegaciÃ³n
- Manejo de errores
- **Expone mÃ©todos y streams para la vista**

### ğŸŒ SERVICIO (services/)
- ComunicaciÃ³n con API
- TransformaciÃ³n de datos API â†” Modelo
- **NO contiene lÃ³gica de UI**

## PatrÃ³n de ImplementaciÃ³n

### Ejemplo: DocumentosListScreen

**ANTES (MonolÃ­tico):**
```dart
// documentos_list_screen.dart (1168 lÃ­neas)
class DocumentosListScreen extends StatefulWidget {
  // UI + LÃ³gica + Servicios TODO MEZCLADO
}
```

**DESPUÃ‰S (MVC):**

```dart
// controllers/documentos/documentos_controller.dart
class DocumentosController extends ChangeNotifier {
  final DocumentoService _service;
  List<Documento> documentos = [];
  bool isLoading = false;
  
  Future<void> cargarDocumentos() async {
    isLoading = true;
    notifyListeners();
    documentos = await _service.getAll();
    isLoading = false;
    notifyListeners();
  }
  
  Future<void> eliminarDocumento(int id) async {
    await _service.delete(id);
    await cargarDocumentos();
  }
}

// views/documentos/documentos_list_view.dart
class DocumentosListView extends StatelessWidget {
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (_) => DocumentosController(context.read<DocumentoService>()),
      child: Consumer<DocumentosController>(
        builder: (context, controller, _) {
          if (controller.isLoading) return LoadingWidget();
          return ListView.builder(
            itemCount: controller.documentos.length,
            itemBuilder: (context, index) {
              return DocumentoCard(
                documento: controller.documentos[index],
                onDelete: () => controller.eliminarDocumento(
                  controller.documentos[index].id
                ),
              );
            },
          );
        },
      ),
    );
  }
}
```

## Fases de MigraciÃ³n

### Fase 1: Crear Estructura Base âœ…
- [x] Crear carpetas `views/` y `controllers/`
- [ ] Crear controladores base

### Fase 2: Migrar MÃ³dulo Documentos (Ejemplo)
- [ ] Crear `DocumentosController`
- [ ] Crear `DocumentosListView`
- [ ] Crear `DocumentoDetailController`
- [ ] Crear `DocumentoDetailView`
- [ ] Migrar widgets a `views/documentos/widgets/`

### Fase 3: Migrar MÃ³dulo Carpetas
- [ ] Crear `CarpetasController`
- [ ] Crear `CarpetasView`

### Fase 4: Migrar MÃ³dulo Admin
- [ ] Crear `UsuariosController`
- [ ] Crear `PermisosController`

### Fase 5: Migrar Auth
- [ ] Refactorizar `AuthProvider` â†’ `AuthController`
- [ ] Crear `LoginView`, `RegisterView`

### Fase 6: Limpieza
- [ ] Eliminar archivos antiguos en `screens/`
- [ ] Actualizar imports en todo el proyecto
- [ ] Documentar

## Ventajas de esta Arquitectura

âœ… **SeparaciÃ³n de responsabilidades clara**
âœ… **CÃ³digo mÃ¡s testeable**
âœ… **FÃ¡cil mantenimiento**
âœ… **ReutilizaciÃ³n de controladores**
âœ… **UI mÃ¡s limpia y legible**
âœ… **Escalabilidad mejorada**

## Notas Importantes

- Los `controllers/` usan `ChangeNotifier` para notificar cambios a la vista
- Las `views/` son **StatelessWidget** siempre que sea posible
- Los `services/` permanecen sin cambios (ya estÃ¡n bien estructurados)
- Los `providers/` globales (como AuthProvider) se mantienen para estado compartido
